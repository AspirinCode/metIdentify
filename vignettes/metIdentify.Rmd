---
title: "metIdentify version0.1.3"
author: |-
      Xiaotao Shen(http://shenxt.sxl.cn/)
      
      School of Medicine, Stanford University
      
date: '`r Sys.Date()`'
output:
  prettydoc::html_pretty:
    highlight: github
    theme: leonids
  pdf_document:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

## **Introduction & Installation**
******************************************

*metIdentify* is a R package which can be used for metabolite identification based on in-house and public database.

Please install it via github.

```{r,eval=FALSE,warning=FALSE, R.options=""}
if(!require(devtools)){
  install.packages("devtools")
}
devtools::install_github("jaspershen/metIdentify")
devtools::install_github("jaspershen/tinyTools")
```

## **Database construction**
******************************************

If you have in-house standard information, you can construct the databases using `metIdentify` package. 

* Firstly, please transform you raw standard MS data (positive and negative modes) into mzXML format using [ProteoWizard](http://proteowizard.sourceforge.net/).
* Secondly, please organize your standard information as a table, and output as a csv or xlsx format.
* Thirdly, please creat a folder and put you mzXML format datasets (positive mode in 'POS' folder and negative mode in 'NEG' folder) and compound information in it.

![](../man/figures/database_construction.png)

* Run `databaseConstruction` function.

We use the demo data in `demoData` package to show how to use `metIdentify`. Please install it first.

```{r,eval=FALSE,warning=FALSE, R.options=""}
devtools::install_github("jaspershen/demoData")
```

```{r,eval=FALSE,warning=FALSE, R.options=""}
library(demoData)
library(metIdentify)
path <- system.file("database_construction", package = "demoData")
file.copy(from = path, to = ".", overwrite = TRUE, recursive = TRUE)
new.path <- file.path("./database_construction")

test.database <- databaseConstruction(path = new.path, 
                                      version = "0.0.1",
                                      metabolite.info.name = "metabolite.info_RPLC.csv", 
                                      source = "Michael Snyder lab", 
                                      link = "http://snyderlab.stanford.edu/",
                                      creater = "Xiaotao Shen",
                                      email = "shenxt1990@163.com",
                                      rt = TRUE,
                                      mz.tol = 15,
                                      rt.tol = 30,
                                      threads = 3)
```

test.database is a `databaseClass` object, you can print it to see its information.

```{r,eval=FALSE,warning=FALSE, R.options=""}
test.database
```

## **Retention time correction**
******************************************

The metabolite retention time may shift in different batches. So if you spike internal standards into your standards and biological samples, you can correct the RTs in database. 

* Firstly, please prepare two internal standard (IS) tables for database and biological samples. 
* The IS table for database should be named as "database.is.table.xlsx" and the IS table for experiment should be named as "experiment.is.table.xlsx".
* Run `rtCor4database` function.

```{r,eval=FALSE,warning=FALSE, R.options=""}
test.database2 <- rtCor4database(experiment.is.table = "experiment.is.table.xlsx", 
                                 database.is.table = "database.is.table.xlsx", 
                                 database = test.database, path = new.path)
```

## **Metabolite identification**
******************************************

### Identify metabolites based on MS2 library

* Prepare your MS2 data

The raw MS2 data from DDA or DIA should be transfered to msp or msp or mzXML files. You can use [ProteoWizard](http://proteowizard.sourceforge.net/).

* Run `metIdentify` function

Place your MS2 data in a folder and then set this folder as your work directory, then run `metIdentify`. We can use the demo data from `demoData`.

![](../man/figures/metabolite_identification.png)

```{r, eval=FALSE, message=TRUE, warning=FALSE}
library(metIdentify)
path <- system.file("ms2_identification_demo_data1", package = "demoData")
file.copy(from = path, to = ".", overwrite = TRUE, recursive = TRUE)
new.path <- file.path("./ms2_identification_demo_data1")
data("msDatabase_rplc0.0.1", package = "metIdentify")
save(msDatabase_rplc0.0.1, file = file.path(new.path, "msDatabase_rplc0.0.1"))
ms2.data <- grep(pattern = "mgf", dir(new.path), value = TRUE)

result <- metIdentify(ms1.data = "ms1.peak.table.csv", ##csv format
           ms2.data = ms2.data,##only msp and mgf and mz(X)ML are supported
           ms1.ms2.match.mz.tol = 25,
           ms1.ms2.match.rt.tol = 10,
           ms1.match.ppm = 25,
           ms2.match.tol = 0.4,
           fraction.weight = 0.3,
           dp.forward.weight = 0.6,
           dp.reverse.weight = 0.1,
           rt.match.tol = 60,
           polarity = "positive", 
           ce = "all",
           column = "rp",
           ms1.match.weight = 0.25,
           rt.match.weight = 0.25,
           ms2.match.weight = 0.5,
           path = new.path,
           total.score.tol = 0,
           candidate.num = 3,
           database = "msDatabase_rplc0.0.1",
           threads = 3)
```

`result` is metIdentifyClass object. You can print it out to see the identificaiton information.

```{r, eval=FALSE,warning=FALSE}
result
```

* You can get processsing parameters from it.

```{r, eval=FALSE,warning=FALSE}
parameters <- getParams(object = result)
parameters
```

* You can get the identification table from it.

```{r, eval=FALSE,warning=FALSE}
identification.table1 <- getIdentificationTable(object = result)
head(identification.table)
```


### **Filter**

You can use `filterIden` function to filer identification results from the `metIdentifyClass` object according to m/z error, rt error, MS2 spectra similarity and total score.

```{r, eval=FALSE,warning=FALSE}
result.new <- filterIden(object = result, ms1.match.ppm = 10)
```

### **MS2 spectra match plot output**

You can also use `ms2plot` function to output the MS2 specra match plot for one, multiple or all peaks.

* Output one MS2 spectra match plot.
```{r, eval=FALSE,warning=FALSE}
##which peaks have identification
peak.name <- whichHasIden(object = result)
head(peak.name)
ms2.plot1 <- ms2plot(object = result, database = msDatabase_rplc0.0.1, 
                     which.peak = peak.name[1,1])
ms2.plot1
```

* You can also output interactive MS2 spectra match plot by setting `interaction.plot` as TRUE.
```{r, eval=FALSE,warning=FALSE}
##which peaks have identification
ms2.plot2 <- ms2plot(object = result, database = msDatabase_rplc0.0.1, 
                     which.peak = peak.name[1,1], interaction.plot = TRUE)
ms2.plot2
```

* You can output all MS2 spectra match plots by setting `which.peak` as "all".

```{r, eval=FALSE, warning=FALSE}
ms2plot(object = result, database = msDatabase_rplc0.0.1, 
                     which.peak = "all", path = file.path(new.path, "inhouse"))
```
Then all the MS2 spectra match plots will be output in the "inhouse" folder.

## **Result integration and output**
**************************************************

You can also use other public database for metabolite identificaiton based on MS2 spectra. We provided four public database, which can be got from the package `demoData`.

1. MassBank database (massbankDatabase0.0.1)
2. MoNA database (monaDatabase0.0.1)
3. HMDB database (hmdbDatabase0.0.1)
4. Orbitrap database from MassBank (orbitrapDatabase0.0.1)

Here, we will use orbitrap database for metabolite identification.

```{r, eval=FALSE, message=TRUE, warning=FALSE}
library(demoData)
library(metIdentify)
path <- system.file("ms2_database", package = "demoData")
file.copy(from = file.path(path, "orbitrapDatabase0.0.1"), 
          to = new.path, overwrite = TRUE, recursive = TRUE)
load(file.path(new.path, "orbitrapDatabase0.0.1"))

result2 <- metIdentify(ms1.data = "ms1.peak.table.csv", ##csv format
           ms2.data = ms2.data,##only msp and mgf and mz(X)ML are supported
           ms1.ms2.match.mz.tol = 25,
           ms1.ms2.match.rt.tol = 10,
           ms1.match.ppm = 25,
           ms2.match.tol = 0.4,
           fraction.weight = 0.3,
           dp.forward.weight = 0.6,
           dp.reverse.weight = 0.1,
           rt.match.tol = 60,
           polarity = "positive", 
           ce = "all",
           column = "rp",
           ms1.match.weight = 0.25,
           rt.match.weight = 0.25,
           ms2.match.weight = 0.5,
           path = new.path,
           total.score.tol = 0,
           candidate.num = 3,
           database = "orbitrapDatabase0.0.1",
           threads = 3)
```

We can also identify metabolites only m/z match, which is level 3 identification according to MSI. We provid the HMDB metabolite database in the `demoData` package.

```{r, eval=FALSE, message=TRUE, warning=FALSE}
library(demoData)
library(metIdentify)
path <- system.file("hmdb_metabolite_database", package = "demoData")
file.copy(from = file.path(path, "HMDB.metabolite.data"), 
          to = new.path, overwrite = TRUE, recursive = TRUE)

result3 <- mzIdentify1(ms1.data = "ms1.peak.table.csv", ##csv format 
           ms1.match.ppm = 25,
           polarity = "positive", 
           column = "rp",
           path = new.path,
           candidate.num = 3,
           database = "HMDB.metabolite.data",
           threads = 3)
```


For result1 using in-hosue database (m/z, RT and MS2 spectra), they are level 1 identifications. For result2 using public MS2 spectra database (m/z and MS2 spectra), they are level 2 identifications. For result3 using HMDB metabolite database (only m/z), they are level 3 identifications according to MSI. So you can integrate those three results together.

```{r, eval=FALSE,warning=FALSE}
identification.table1 <- getIdentificationTable(object = result, candidate.num = 1, type = "new")
identification.table1 <- identification.table1[!is.na(identification.table1$Compound.name),,drop = FALSE]

identification.table2 <- getIdentificationTable(object = result2, candidate.num = 1, type = "new")
identification.table2 <- identification.table2[!is.na(identification.table2$Compound.name),,drop = FALSE]
identification.table2 <- identification.table2[!(identification.table2$name %in% identification.table1$name),,drop = FALSE]

identification.table3 <- getIdentificationTable2(object = result3, candidate.num = 1, type = "new")
identification.table3 <- identification.table3[!is.na(identification.table3$Compound.name),,drop = FALSE]
identification.table3 <- identification.table3[!(identification.table3$name %in% c(identification.table1$name,identification.table1$name)),,drop = FALSE]

identification.table1 <- data.frame(identification.table1, Level = 1, stringsAsFactors = FALSE)
identification.table2 <- data.frame(identification.table2, Level = 2, stringsAsFactors = FALSE)
identification.table3 <- data.frame(identification.table3[-11], 
                                    "mz.match.score" = NA,
                                    "RT.error" = NA,
                                    "RT.match.score" = NA, 
                                    "CE" = NA,  
                                    "SS" = NA,
                                    "Total.score" = NA,
                                    identification.table3[11],
                                    Level = 3, stringsAsFactors = FALSE)

identification.table <- rbind(identification.table1, 
                              identification.table2, 
                              identification.table3)

write.csv(identification.table, file = file.path(new.path, "identification.table.csv"), row.names = FALSE)
```



